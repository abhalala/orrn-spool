<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
     x-data="{ show: true }"
     x-init="$nextTick(() => show = true)"
     x-show="show"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     @keydown.escape.window="show = false; $dispatch('modal-close')">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
       @click.stop
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0 transform scale-95"
       x-transition:enter-end="opacity-100 transform scale-100">
    <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
      <h3 class="text-lg font-semibold text-gray-900">Job #{{ .Job.ID }}</h3>
      <button @click="show = false" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="p-4 space-y-4">
      <div class="flex items-center space-x-2">
        <span class="font-medium text-gray-700">Status:</span>
        <span class="px-3 py-1 rounded-full text-xs font-medium
          {{ if eq .Job.Status "completed" }}bg-green-100 text-green-800{{ end }}
          {{ if eq .Job.Status "failed" }}bg-red-100 text-red-800{{ end }}
          {{ if eq .Job.Status "cancelled" }}bg-gray-100 text-gray-800{{ end }}
          {{ if eq .Job.Status "processing" }}bg-yellow-100 text-yellow-800{{ end }}
          {{ if eq .Job.Status "pending" }}bg-blue-100 text-blue-800{{ end }}
          {{ if eq .Job.Status "paused" }}bg-gray-100 text-gray-800{{ end }}">
          {{ .Job.Status | title }}
        </span>
        {{ if gt .Job.Priority 0 }}
        <span class="px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-800">
          Priority: {{ .Job.Priority }}
        </span>
        {{ end }}
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-50 rounded-lg p-3">
          <span class="text-sm text-gray-500">Printer</span>
          <p class="font-medium text-gray-900">{{ .Job.PrinterName }}</p>
          <p class="text-xs text-gray-400 mt-1">{{ .Job.PrinterIP }}</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-3">
          <span class="text-sm text-gray-500">Template</span>
          <p class="font-medium text-gray-900">{{ .Job.TemplateName }}</p>
          <p class="text-xs text-gray-400 mt-1">Copies: {{ .Job.Copies }}</p>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-700">Variables</span>
          <button @click="variablesExpanded = !variablesExpanded" 
                  class="text-xs text-primary-600 hover:text-primary-700">
            <span x-text="variablesExpanded ? 'Collapse' : 'Expand'"></span>
          </button>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 overflow-hidden">
          <pre class="text-sm text-gray-700 whitespace-pre-wrap" 
               :class="variablesExpanded ? '' : 'max-h-24 overflow-hidden'">{{ .VariablesJSON }}</pre>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-700">TSPL2 Commands</span>
          <button @click="tsplExpanded = !tsplExpanded" 
                  class="text-xs text-primary-600 hover:text-primary-700">
            <span x-text="tsplExpanded ? 'Collapse' : 'Expand'"></span>
          </button>
        </div>
        <div class="bg-gray-900 rounded-lg p-3 overflow-hidden">
          <pre class="text-xs text-green-400 font-mono whitespace-pre" 
               :class="tsplExpanded ? '' : 'max-h-32 overflow-hidden'">{{ .Job.TSPLContent }}</pre>
        </div>
        <button onclick="navigator.clipboard.writeText(`{{ .Job.TSPLContent }}`)"
                class="mt-2 text-xs text-gray-500 hover:text-gray-700 flex items-center">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          Copy to clipboard
        </button>
      </div>

      <div>
        <span class="text-sm font-medium text-gray-700">Timeline</span>
        <div class="mt-3 relative">
          <div class="absolute left-2 top-0 bottom-0 w-0.5 bg-gray-200"></div>
          <div class="space-y-4">
            <div class="flex items-start ml-1">
              <div class="w-4 h-4 rounded-full bg-blue-500 border-2 border-white z-10"></div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-900">Created</p>
                <p class="text-xs text-gray-500">{{ .Job.CreatedAt.Format "2006-01-02 15:04:05" }}</p>
              </div>
            </div>
            {{ if .Job.StartedAt }}
            <div class="flex items-start ml-1">
              <div class="w-4 h-4 rounded-full bg-yellow-500 border-2 border-white z-10"></div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-900">Processing Started</p>
                <p class="text-xs text-gray-500">{{ .Job.StartedAt.Format "2006-01-02 15:04:05" }}</p>
                <p class="text-xs text-gray-400">Wait time: {{ .WaitDuration }}</p>
              </div>
            </div>
            {{ end }}
            {{ if .Job.CompletedAt }}
            <div class="flex items-start ml-1">
              <div class="w-4 h-4 rounded-full {{ if eq .Job.Status "completed" }}bg-green-500{{ else }}bg-red-500{{ end }} border-2 border-white z-10"></div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-900">{{ if eq .Job.Status "completed" }}Completed{{ else }}Failed{{ end }}</p>
                <p class="text-xs text-gray-500">{{ .Job.CompletedAt.Format "2006-01-02 15:04:05" }}</p>
                <p class="text-xs text-gray-400">Processing time: {{ .ProcessingDuration }}ms</p>
              </div>
            </div>
            {{ end }}
          </div>
        </div>
      </div>

      {{ if .Job.ErrorMessage }}
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-red-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <div>
            <span class="text-red-800 font-medium">Error</span>
            <p class="text-red-700 text-sm mt-1">{{ .Job.ErrorMessage }}</p>
          </div>
        </div>
      </div>
      {{ end }}

      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-gray-500">Job ID:</span>
          <span class="ml-2 font-mono text-gray-700">{{ .Job.ID }}</span>
        </div>
        <div>
          <span class="text-gray-500">Total Duration:</span>
          <span class="ml-2 text-gray-700">{{ .TotalDuration }}</span>
        </div>
      </div>
    </div>
    
    <div class="p-4 border-t bg-gray-50 flex justify-end space-x-3 sticky bottom-0">
      {{ if eq .Job.Status "completed" }}
      <button hx-post="/api/jobs/{{ .Job.ID }}/reprint"
              hx-target="#modal-container"
              hx-swap="outerHTML"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Reprint
      </button>
      {{ end }}
      {{ if eq .Job.Status "failed" }}
      <button hx-post="/api/jobs/{{ .Job.ID }}/retry"
              hx-target="#modal-container"
              hx-swap="outerHTML"
              class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Retry
      </button>
      {{ end }}
      {{ if or (eq .Job.Status "pending") (eq .Job.Status "paused") }}
      <button hx-post="/api/jobs/{{ .Job.ID }}/cancel"
              hx-target="#modal-container"
              hx-swap="outerHTML"
              hx-confirm="Are you sure you want to cancel this job?"
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Cancel Job
      </button>
      {{ end }}
      <button @click="show = false" 
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-100 transition-colors">
        Close
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('jobDetail', () => ({
    variablesExpanded: false,
    tsplExpanded: false
  }));
});
</script>
